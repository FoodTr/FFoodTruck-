<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks PRO - Studio Produit</title>

<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/gerant.css">


</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="back-btn" id="btn-back">‚Üê</div>
        <h2 style="margin:0; font-weight: 900; font-style: italic;">STUDIO FFoodTrucks</h2>
    </div>

<label>Rendu visuel IA</label>
<div class="ia-camera-box" id="ia-box">
    <div class="ai-status-badge">‚ú® IA OPTIMISEUR</div>
    <div id="instruction" style="text-align:center;">
        <span style="font-size: 50px;">üì∏</span><br>
        <span style="font-size: 12px; color: #888;">Prendre la photo brute du plat</span>
    </div>
    <img id="preview-img">
    <div id="ai-processing" class="ai-loader">
        <div class="scan-line"></div>
        <div style="font-weight: bold; color: #FF3B30; letter-spacing: 2px;">TRAITEMENT IA EN COURS...</div>
        <div style="font-size: 11px; color: #666; margin-top: 5px;">Nettoyage du fond & √âclairage studio</div>
    </div>
</div>

<label>Cat√©gorie de produit</label>
<input type="text" id="cat-search" class="cat-search-input" placeholder="üîç Chercher...">
<div class="category-selector" id="cat-container"></div>

<label>Labels Alimentaires</label>
<div class="labels-grid" id="labels-container">
    <div class="label-box">üåø VEGAN</div>
    <div class="label-box">ü•ó V√âG√âTARIEN</div>
    <div class="label-box">ü•© HALAL</div>
    <div class="label-box">üåæ SANS GLUTEN</div>
</div>

<label>Nom du plat</label>
<input type="text" id="p-name" class="main-input" placeholder="ex: Le Double Bacon Cheese">

<label>Prix de vente (‚Ç¨)</label>
<input type="number" id="p-price" step="0.50" class="main-input" placeholder="12.00">

<label>Description & Ingr√©dients</label>
<textarea id="p-desc" class="main-input" rows="3" style="font-size:14px;" placeholder="D√©taillez votre recette..."></textarea>

<button id="btn-pub" class="btn-publish">AJOUTER √Ä LA CARTE</button>

</div>

<script type="module">
    import { auth, db, ts } from './firebase-config.js';
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const categories = ["üçî Burgers", "üçï Pizzas", "üåÆ Tacos", "üåØ Kebabs", "üç± Sushis", "ü•ó Salades", "üçü Frites/Sides", "üç© Desserts", "ü•§ Boissons"];
    let selectedCat = "üçî Burgers";
    let currentImg = "";

    document.getElementById('btn-back').onclick = () => window.location.href = 'gerant_dashboard.html';

    onAuthStateChanged(auth, user => {
        if (!user) window.location.href = 'gerant_auth.html';
    });

    function displayCats(list) {
        const container = document.getElementById('cat-container');
        container.innerHTML = "";
        list.forEach(c => {
            const chip = document.createElement('div');
            chip.className = 'cat-chip' + (selectedCat === c ? ' active' : '');
            chip.innerText = c;
            chip.onclick = () => { 
                selectedCat = c; 
                displayCats(categories); 
            };
            container.appendChild(chip);
        });
    }

    document.getElementById('cat-search').onkeyup = function() {
        const val = this.value.toLowerCase();
        const filtered = categories.filter(c => c.toLowerCase().includes(val));
        displayCats(filtered);
    };

    document.querySelectorAll('.label-box').forEach(box => {
        box.onclick = function() {
            this.classList.toggle('selected');
        };
    });

    document.getElementById('ia-box').onclick = function() {
        const loader = document.getElementById('ai-processing');
        const preview = document.getElementById('preview-img');
        const instruction = document.getElementById('instruction');
        
        loader.style.display = 'flex';
        setTimeout(() => {
            loader.style.display = 'none';
            instruction.style.display = 'none';
            preview.style.display = 'block';
            currentImg = "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=500";
            preview.src = currentImg;
        }, 1500);
    };

    document.getElementById('btn-pub').onclick = async function() {
        const user = auth.currentUser;
        if (!user) return alert("‚ùå Session expir√©e.");

        const name = document.getElementById('p-name').value.trim();
        const price = parseFloat(document.getElementById('p-price').value);
        const desc = document.getElementById('p-desc').value.trim();
        const btn = document.getElementById('btn-pub');

        if (!name || name.length < 3) return alert("‚ö†Ô∏è Nom trop court");
        if (!price || price <= 0) return alert("‚ö†Ô∏è Prix invalide");

        let labels = [];
        document.querySelectorAll('.label-box.selected').forEach(box => labels.push(box.innerText));

        btn.disabled = true;
        btn.innerText = "PUBLICATION...";

        try {
            await addDoc(collection(db, "menu"), {
                truckId: user.uid,
                name: name,
                price: price,
                desc: desc,
                category: selectedCat,
                labels: labels,
                image: currentImg || "https://via.placeholder.com/150",
                stock: true,
                createdAt: ts()
            });

            alert("üöÄ PRODUIT AJOUT√â !");
            window.location.href = 'gerant_carte.html';
        } catch (e) {
            alert("‚ùå Erreur : " + e.message);
            btn.disabled = false;
            btn.innerText = "AJOUTER √Ä LA CARTE";
        }
    };

    displayCats(categories);
</script>

</body>
</html>
