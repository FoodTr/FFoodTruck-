<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - Mon Profil</title>

<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/client.css">


</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="back-btn" id="btn-back">‚Üê</div>
        <div class="logo-text">F<span>F</span>oodTrucks</div>
    </div>

<div class="container">
    <div class="info-grid">
        <div class="info-box">
            <span class="box-title">Identit√©</span>
            <span class="info-line">Pr√©nom : <b id="display-firstName">...</b></span>
            <span class="info-line">Nom : <b id="display-lastName">...</b></span>
            <span class="info-line">Email : <b id="display-email">...</b></span>
        </div>
        <div class="info-box">
            <span class="box-title">Contact</span>
            <span class="info-line">T√©l : <b id="display-phone">...</b></span>
            <span class="info-line">Compte : <b id="display-role">Client</b></span>
        </div>
    </div>

    <div class="history-title">Suivi de commande</div>
    <div id="history-container">
        <p style="font-size: 13px; color: #999; text-align: center; padding: 20px;">Chargement de vos commandes...</p>
    </div>

    <div class="logout-container">
        <button class="logout-btn" id="btn-logout">D√âCONNEXION</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-btn" id="nav-home">üìç</div>
    <div class="nav-btn" id="nav-cart">üõí</div>
    <div class="nav-btn active">üë§</div>
</nav>

</div>

<script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, collection, query, where, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    document.getElementById('btn-back').onclick = () => window.location.href = 'index.html';
    document.getElementById('nav-home').onclick = () => window.location.href = 'index.html';
    document.getElementById('nav-cart').onclick = () => window.location.href = 'panier.html';

    onAuthStateChanged(auth, user => {
        if (user) {
            loadUserData(user.uid);
            loadOrderHistory(user.uid);
        } else {
            window.location.href = 'connexion.html';
        }
    });

    async function loadUserData(uid) {
        try {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('display-firstName').innerText = data.firstName || data.truckName || "-";
                document.getElementById('display-lastName').innerText = data.lastName || (data.role === 'gerant' ? '(PRO)' : "-");
                document.getElementById('display-email').innerText = data.email || "-";
                document.getElementById('display-phone').innerText = data.phone || "-";
                document.getElementById('display-role').innerText = data.role === 'gerant' ? 'G√©rant' : 'Client';
            }
        } catch (e) { console.error("Erreur profil:", e); }
    }

    function loadOrderHistory(uid) {
        const container = document.getElementById('history-container');
        const q = query(
            collection(db, "commandes"),
            where("clientId", "==", uid),
            orderBy("createdAt", "desc"),
            limit(10)
        );

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                container.innerHTML = `<div style="text-align:center; padding:30px; color:#ccc; font-size:14px;">Aucune commande pour le moment.</div>`;
                return;
            }

            container.innerHTML = "";
            snapshot.forEach(orderDoc => {
                const cmd = orderDoc.data();
                const date = cmd.createdAt ? cmd.createdAt.toDate().toLocaleDateString('fr-FR', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : "En cours...";
                const statusClean = (cmd.status || 'En attente').normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '_');
                
                container.innerHTML += `
                    <div class="order-card">
                        <span class="status-pill status-${statusClean}">${cmd.status || 'En attente'}</span>
                        <div style="font-weight: 800; font-size: 14px;">Commande du ${date}</div>
                        <div style="font-size: 12px; color: #777; margin-top: 5px;">
                            ${cmd.items ? cmd.items.map(i => `${i.quantity}x ${i.name}`).join(', ') : '...'}
                        </div>
                        <div style="font-weight: 900; margin-top: 10px; color: #FF3B30;">Total : ${parseFloat(cmd.totalPrice || 0).toFixed(2)}‚Ç¨</div>
                    </div>`;
            });
        }, (error) => {
            console.error("Erreur Snapshot:", error);
            container.innerHTML = `<div style="text-align:center; padding:20px; color:red; font-size:12px;">Erreur de chargement.</div>`;
        });
    }

    document.getElementById('btn-logout').onclick = () => {
        if(confirm("Voulez-vous vraiment vous d√©connecter ?")) {
            signOut(auth).then(() => window.location.href = 'index.html');
        }
    };
</script>

</body>
</html>
