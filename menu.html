<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - Menu</title>

<style>
    /* TON CSS CONSERV√â ET OPTIMIS√â */
    @media (min-width: 768px) {
        body { display: flex; flex-direction: column; align-items: center; background: #000; }
        .main-wrapper { max-width: 500px; width: 100%; border-left: 1px solid #333; border-right: 1px solid #333; position: relative; min-height: 100vh; }
    }
    body { font-family: -apple-system, sans-serif; margin: 0; background-color: #f8f8f8; color: #333; padding-bottom: 100px; scroll-behavior: smooth; }
    .main-wrapper { background: #f8f8f8; width: 100%; }
    
    .truck-header { height: 180px; background: #333; position: relative; background-image: url('https://images.unsplash.com/photo-1565061828021-dd353ba0a107?q=80&w=1000'); background-size: cover; background-position: center; }
    .back-btn { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10; border: none; }
    
    .truck-details { background: white; margin-top: -30px; border-radius: 30px 30px 0 0; padding: 25px; position: relative; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
    .truck-name { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
    .tag { font-size: 11px; padding: 4px 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 20px; font-weight: bold; margin-right: 5px; color: #666; }
    
    .category-nav { position: sticky; top: 0; background: white; z-index: 90; display: flex; gap: 15px; padding: 15px 20px; overflow-x: auto; border-bottom: 1px solid #eee; scrollbar-width: none; }
    .category-nav::-webkit-scrollbar { display: none; }
    .nav-item { white-space: nowrap; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; text-decoration: none; padding-bottom: 5px; }
    .nav-item.active { color: #FF3B30; border-bottom: 2px solid #FF3B30; }
    
    .menu-section { padding: 10px 20px; }
    .category-title { font-size: 20px; font-weight: 800; margin: 30px 0 15px 0; }
    
    .product-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #eee; transition: 0.2s; }
    .product-img { width: 80px; height: 80px; background: #eee; border-radius: 15px; margin-right: 15px; object-fit: cover; }
    .product-info { flex: 1; }
    .product-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
    .product-desc { font-size: 12px; color: #777; margin-bottom: 8px; line-height: 1.3; }
    .product-price { font-weight: 900; font-size: 15px; color: #333; }
    
    .quantity-controls { display: flex; align-items: center; gap: 12px; background: #f0f0f0; padding: 5px 10px; border-radius: 12px; }
    .qty-btn { width: 28px; height: 28px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .qty-display { font-weight: 900; font-size: 15px; min-width: 20px; text-align: center; }
    .add-btn { width: 35px; height: 35px; background: #333; color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    
    .cart-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 460px; background: #333; color: white; padding: 18px; border-radius: 20px; display: none; justify-content: space-between; align-items: center; font-weight: bold; z-index: 1000; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .cart-count-badge { background: #FF3B30; border-radius: 8px; padding: 4px 8px; font-size: 12px; margin-left: 10px; }
    #store-badge { position: absolute; top: 25px; right: 25px; color: white; padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: 900; letter-spacing: 0.5px; }
</style>

</head>
<body>

<div class="main-wrapper">
    <div class="truck-header" id="truck-banner">
        <button class="back-btn" id="btn-back">‚Üê</button>
    </div>

<div class="truck-details">
    <div id="store-badge" style="background: #999;">CHARGEMENT...</div>
    <div class="truck-name" id="truck-name">Chargement...</div>
    <div style="font-size: 13px; color: #666;" id="truck-desc">...</div>
    <div style="margin-top: 10px;" id="truck-tags"></div>
</div>

<div class="category-nav" id="cat-nav"></div>

<div class="menu-section" id="menu-container">
    <div style="text-align:center; padding:50px; color:#999;">Pr√©paration de la carte...</div>
</div>

<div class="cart-bar" id="cartBar">
    <div style="display: flex; align-items: center;">
        üõí VOIR LE PANIER
        <span class="cart-count-badge" id="cartCount">0</span>
    </div>
    <span id="cartTotal">0,00 ‚Ç¨</span>
</div>

</div>

<script type="module">
    import { db } from './firebase-config.js';
    import { doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const truckId = urlParams.get('id');
    
    let cart = JSON.parse(localStorage.getItem('ff_cart')) || [];
    let isTruckOpen = false;
    let products = [];

    if (!truckId) {
        window.location.href = 'index.html';
    }

    // --- NAVIGATION ---
    document.getElementById('btn-back').onclick = () => window.location.href = 'index.html';
    document.getElementById('cartBar').onclick = () => window.location.href = 'panier.html';

    // --- INFOS DU TRUCK ---
    onSnapshot(doc(db, "users", truckId), (snap) => {
        if (snap.exists()) {
            const data = snap.data();
            document.getElementById('truck-name').innerText = data.truckName || 'Food Truck';
            document.getElementById('truck-desc').innerText = data.description || "S√©lection du chef";
            if (data.image) document.getElementById('truck-banner').style.backgroundImage = `url(${data.image})`;
            
            isTruckOpen = data.isOpen;
            const badge = document.getElementById('store-badge');
            badge.innerText = isTruckOpen ? "OUVERT" : "FERM√â";
            badge.style.background = isTruckOpen ? "#4CAF50" : "#FF3B30";

            if (data.specialities) {
                document.getElementById('truck-tags').innerHTML = data.specialities.map(s => 
                    `<span class="tag">${s}</span>`
                ).join('');
            }
        }
    });

    // --- √âCOUTE DU MENU ---
    const qMenu = query(collection(db, "menu"), where("truckId", "==", truckId));
    onSnapshot(qMenu, (snap) => {
        products = [];
        snap.forEach(docSnap => {
            const p = docSnap.data();
            products.push({
                id: docSnap.id,
                name: p.name || p.nom,
                price: parseFloat(p.price || p.prix || 0),
                ...p
            });
        });
        renderMenu();
    });

    function renderMenu() {
        const container = document.getElementById('menu-container');
        const nav = document.getElementById('cat-nav');
        
        if (products.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>Menu bient√¥t disponible...</div>";
            return;
        }

        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        nav.innerHTML = categories.map((cat, i) => `
            <a href="#cat-${i}" class="nav-item ${i===0?'active':''}" onclick="setActive(this)">${cat}</a>
        `).join('');

        container.innerHTML = "";
        categories.forEach((cat, i) => {
            let html = `<div id="cat-${i}" class="category-title">${cat}</div>`;
            
            products.filter(p => p.category === cat).forEach(prod => {
                const cartItem = cart.find(item => item.id === prod.id);
                const qty = cartItem ? cartItem.quantity : 0;
                const available = isTruckOpen && prod.stock !== false;
                
                html += `
                    <div class="product-card" style="${!available ? 'opacity: 0.6;' : ''}">
                        <img src="${prod.image || 'https://via.placeholder.com/80'}" class="product-img">
                        <div class="product-info">
                            <div class="product-name">${prod.name}</div>
                            <div class="product-desc">${prod.desc || ''}</div>
                            <div class="product-price">${prod.price.toFixed(2)} ‚Ç¨</div>
                            ${prod.stock === false ? '<div style="color:#FF3B30; font-size:10px; font-weight:bold; margin-top:5px;">√âPUIS√â</div>' : ''}
                        </div>
                        <div class="action-area">
                            ${available ? (
                                qty > 0 ? 
                                `<div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', -1)">‚àí</button>
                                    <div class="qty-display">${qty}</div>
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', 1)">+</button>
                                </div>` :
                                `<div class="add-btn" onclick="updateCart('${prod.id}', 1)">+</div>`
                            ) : ''}
                        </div>
                    </div>`;
            });
            container.innerHTML += html;
        });
        updateCartDisplay();
    }

    // --- PANIER ---
    window.updateCart = (productId, change) => {
        const prod = products.find(p => p.id === productId);
        if (!isTruckOpen) return alert("‚ö†Ô∏è Ce Food Truck est ferm√©");
        
        const idx = cart.findIndex(item => item.id === productId);
        
        // V√©rifier si le panier appartient √† un autre truck
        if (cart.length > 0 && cart[0].truckId !== truckId) {
            if (confirm("Votre panier contient des produits d'un autre truck. Le vider ?")) {
                cart = [];
            } else return;
        }

        if (idx >= 0) {
            cart[idx].quantity += change;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
        } else if (change > 0) {
            cart.push({ id: prod.id, name: prod.name, price: prod.price, truckId: truckId, quantity: 1 });
        }

        localStorage.setItem('ff_cart', JSON.stringify(cart));
        renderMenu();
    };

    function updateCartDisplay() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalVal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const bar = document.getElementById('cartBar');
        
        if (totalItems > 0) {
            bar.style.display = 'flex';
            document.getElementById('cartCount').innerText = totalItems;
            document.getElementById('cartTotal').innerText = totalVal.toFixed(2).replace('.', ',') + " ‚Ç¨";
        } else {
            bar.style.display = 'none';
        }
    }

    window.setActive = (el) => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    updateCartDisplay();
</script>

</body>
</html>
