<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - Menu</title>

<style>
    /* --- STYLE ROBUSTE POUR TESTS M√âDIATH√àQUE --- */
    body { 
        font-family: -apple-system, sans-serif; 
        margin: 0; 
        background-color: #f8f8f8; 
        color: #333; 
        padding-bottom: 120px; 
        scroll-behavior: smooth; 
        display: flex;
        justify-content: center;
        min-height: 100vh;
    }

    .main-wrapper { 
        background: #f8f8f8; 
        width: 100%; 
        max-width: 700px; 
        border-left: 1px solid #eee;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* Panier Flottant */
    .cart-bar { 
        position: fixed; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        width: calc(100% - 40px); 
        max-width: 660px; 
        background: #1a1a1a; 
        color: white; 
        padding: 20px; 
        border-radius: 20px; 
        display: none; 
        justify-content: space-between; 
        align-items: center; 
        font-weight: 900; 
        z-index: 2000; 
        cursor: pointer; 
        box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
    }

    .truck-header { height: 200px; background: #333; position: relative; background-image: url('https://images.unsplash.com/photo-1565061828021-dd353ba0a107?q=80&w=1000'); background-size: cover; background-position: center; width: 100%; }
    .back-btn { position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: none; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    .truck-details { background: white; margin-top: -40px; border-radius: 40px 40px 0 0; padding: 30px 25px; position: relative; box-shadow: 0 -10px 30px rgba(0,0,0,0.05); }
    .truck-name { font-size: 26px; font-weight: 900; margin-bottom: 8px; color: #1a1a1a; }
    .tag { font-size: 11px; padding: 6px 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 20px; font-weight: bold; margin-right: 8px; color: #666; display: inline-block; margin-bottom: 5px; }
    
    .category-nav { position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 90; display: flex; gap: 20px; padding: 15px 25px; overflow-x: auto; border-bottom: 1px solid #eee; scrollbar-width: none; width: 100%; box-sizing: border-box; }
    .category-nav::-webkit-scrollbar { display: none; }
    .nav-item { white-space: nowrap; font-size: 14px; font-weight: 800; color: #aaa; cursor: pointer; text-decoration: none; transition: 0.3s; }
    .nav-item.active { color: #FF3B30; }
    
    .menu-section { padding: 10px 20px; flex: 1; }
    .category-title { font-size: 22px; font-weight: 900; margin: 35px 0 20px 0; color: #1a1a1a; }
    
    /* Carte Produit */
    .product-card { background: white; border-radius: 25px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .product-img { width: 90px; height: 90px; background: #f0f0f0; border-radius: 20px; margin-right: 15px; object-fit: cover; }
    .product-info { flex: 1; }
    .product-name { font-weight: 800; font-size: 17px; margin-bottom: 4px; color: #1a1a1a; }
    .product-desc { font-size: 12px; color: #888; margin-bottom: 10px; line-height: 1.4; }
    .product-price { font-weight: 900; font-size: 16px; color: #1a1a1a; }
    
    /* Boutons de contr√¥le */
    .quantity-controls { display: flex; align-items: center; gap: 15px; background: #f5f5f5; padding: 6px 12px; border-radius: 15px; }
    .qty-btn { width: 32px; height: 32px; background: white; color: #1a1a1a; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; border: 1px solid #eee; }
    .qty-display { font-weight: 900; font-size: 16px; min-width: 20px; text-align: center; }
    .add-btn { width: 40px; height: 40px; background: #1a1a1a; color: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; }
    
    .cart-count-badge { background: #FF3B30; border-radius: 10px; padding: 4px 10px; font-size: 13px; margin-left: 12px; }
    #store-badge { position: absolute; top: 30px; right: 25px; color: white; padding: 8px 18px; border-radius: 25px; font-size: 12px; font-weight: 900; text-transform: uppercase; }
</style>

</head>
<body>

<div class="main-wrapper">
    <div class="truck-header" id="truck-banner">
        <button class="back-btn" id="btn-back">‚Üê</button>
    </div>

<div class="truck-details">
    <div id="store-badge" style="background: #999;">FERM√â</div>
    <div class="truck-name" id="truck-name">Chargement...</div>
    <div style="font-size: 14px; color: #777; line-height: 1.5;" id="truck-desc">Nous pr√©parons les fourneaux...</div>
    <div style="margin-top: 15px;" id="truck-tags"></div>
</div>

<div class="category-nav" id="cat-nav"></div>

<div class="menu-section" id="menu-container">
    <div style="text-align:center; padding:60px; color:#aaa; font-style: italic;">Lecture de la carte...</div>
</div>

<div class="cart-bar" id="cartBar">
    <div style="display: flex; align-items: center;">
        üõí VOIR PANIER
        <span class="cart-count-badge" id="cartCount">0</span>
    </div>
    <span id="cartTotal">0,00 ‚Ç¨</span>
</div>

</div>

<script type="module">
    import { db } from './firebase-config.js';
    import { doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const truckId = urlParams.get('id');
    
    let cart = JSON.parse(localStorage.getItem('ff_cart')) || [];
    let isTruckOpen = false;
    let products = [];

    if (!truckId) window.location.href = 'index.html';

    document.getElementById('btn-back').onclick = () => window.location.href = 'index.html';
    document.getElementById('cartBar').onclick = () => window.location.href = 'panier.html';

    // 1. Infos du Truck
    onSnapshot(doc(db, "users", truckId), (snap) => {
        if (snap.exists()) {
            const data = snap.data();
            document.getElementById('truck-name').innerText = data.truckName || 'Food Truck';
            document.getElementById('truck-desc').innerText = data.description || "Bienvenue dans notre cuisine nomade !";
            if (data.image) document.getElementById('truck-banner').style.backgroundImage = `url(${data.image})`;
            
            isTruckOpen = data.isOpen;
            const badge = document.getElementById('store-badge');
            badge.innerText = isTruckOpen ? "OUVERT" : "FERM√â";
            badge.style.background = isTruckOpen ? "#4CAF50" : "#FF3B30";

            if (data.specialities) {
                document.getElementById('truck-tags').innerHTML = data.specialities.map(s => 
                    `<span class="tag">${s}</span>`
                ).join('');
            }
        }
    });

    // 2. √âcoute du Menu
    const qMenu = query(collection(db, "menu"), where("truckId", "==", truckId));
    onSnapshot(qMenu, (snap) => {
        products = [];
        snap.forEach(docSnap => {
            const p = docSnap.data();
            products.push({ id: docSnap.id, ...p });
        });
        renderMenu();
    });

    // 3. Rendu du Menu (Cat√©gories + Produits)
    function renderMenu() {
        const container = document.getElementById('menu-container');
        const nav = document.getElementById('cat-nav');
        
        if (products.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:60px; color:#aaa;'>La carte est en cours de mise √† jour... üçü</div>";
            return;
        }

        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        
        // Nav
        nav.innerHTML = categories.map((cat, i) => `
            <a href="#cat-${i}" class="nav-item ${i===0?'active':''}" onclick="setActive(this)">${cat}</a>
        `).join('');

        // Menu
        container.innerHTML = "";
        categories.forEach((cat, i) => {
            let html = `<div id="cat-${i}" class="category-title">${cat}</div>`;
            
            products.filter(p => p.category === cat).forEach(prod => {
                const cartItem = cart.find(item => item.id === prod.id);
                const qty = cartItem ? cartItem.quantity : 0;
                const available = isTruckOpen && prod.stock !== false;
                
                html += `
                    <div class="product-card" style="${!available ? 'opacity: 0.6;' : ''}">
                        <img src="${prod.image || 'https://via.placeholder.com/90'}" class="product-img">
                        <div class="product-info">
                            <div class="product-name">${prod.name}</div>
                            <div class="product-desc">${prod.desc || 'Recette du chef'}</div>
                            <div class="product-price">${parseFloat(prod.price).toFixed(2)} ‚Ç¨</div>
                        </div>
                        <div class="action-area">
                            ${available ? (
                                qty > 0 ? 
                                `<div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', -1)">‚àí</button>
                                    <div class="qty-display">${qty}</div>
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', 1)">+</button>
                                </div>` :
                                `<div class="add-btn" onclick="updateCart('${prod.id}', 1)">+</div>`
                            ) : '<div style="font-size:10px; font-weight:bold; color:#FF3B30;">INDISPO</div>'}
                        </div>
                    </div>`;
            });
            container.innerHTML += html;
        });
        updateCartDisplay();
    }

    // 4. Gestion Panier
    window.updateCart = (productId, change) => {
        if (!isTruckOpen) return alert("D√©sol√©, ce truck est actuellement ferm√© !");
        
        const prod = products.find(p => p.id === productId);
        const idx = cart.findIndex(item => item.id === productId);
        
        // S√©curit√© : Un seul truck par panier
        if (cart.length > 0 && cart[0].truckId !== truckId) {
            if (confirm("Votre panier contient d√©j√† des produits d'un autre truck. Voulez-vous le vider pour commander ici ?")) {
                cart = [];
            } else return;
        }

        if (idx >= 0) {
            cart[idx].quantity += change;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
        } else if (change > 0) {
            cart.push({ 
                id: prod.id, 
                name: prod.name, 
                price: parseFloat(prod.price), 
                truckId: truckId, 
                quantity: 1 
            });
        }

        localStorage.setItem('ff_cart', JSON.stringify(cart));
        renderMenu();
    };

    function updateCartDisplay() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalVal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const bar = document.getElementById('cartBar');
        
        if (totalItems > 0) {
            bar.style.display = 'flex';
            document.getElementById('cartCount').innerText = totalItems;
            document.getElementById('cartTotal').innerText = totalVal.toFixed(2).replace('.', ',') + " ‚Ç¨";
        } else {
            bar.style.display = 'none';
        }
    }

    window.setActive = (el) => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    updateCartDisplay();
</script>

</body>
</html>
