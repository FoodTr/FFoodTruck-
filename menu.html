<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - Menu</title>

<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/client.css">


</head>
<body>

<div class="main-wrapper">
    <div class="truck-header" id="truck-banner">
        <button class="back-btn" id="btn-back">‚Üê</button>
    </div>

<div class="truck-details">
    <div id="store-badge" style="background: #999;">CHARGEMENT...</div>
    <div class="truck-name" id="truck-name">Chargement...</div>
    <div style="font-size: 13px; color: #666;" id="truck-desc">...</div>
    <div style="margin-top: 10px;" id="truck-tags"></div>
</div>

<div class="category-nav" id="cat-nav"></div>

<div class="menu-section" id="menu-container">
    <div style="text-align:center; padding:50px; color:#999;">Pr√©paration de la carte...</div>
</div>

<div class="cart-bar" id="cartBar">
    <div style="display: flex; align-items: center;">
        üõí VOIR LE PANIER
        <span class="cart-count-badge" id="cartCount">0</span>
    </div>
    <span id="cartTotal">0,00 ‚Ç¨</span>
</div>

</div>

<script type="module">
    import { db } from './firebase-config.js';
    import { doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const truckId = urlParams.get('id');
    
    let cart = JSON.parse(localStorage.getItem('ff_cart')) || [];
    let isTruckOpen = false;
    let products = [];

    if (!truckId) {
        window.location.href = 'index.html';
    }

    document.getElementById('btn-back').onclick = () => window.location.href = 'index.html';
    document.getElementById('cartBar').onclick = () => window.location.href = 'panier.html';

    onSnapshot(doc(db, "users", truckId), (snap) => {
        if (snap.exists()) {
            const data = snap.data();
            document.getElementById('truck-name').innerText = data.truckName || 'Food Truck';
            document.getElementById('truck-desc').innerText = data.description || "S√©lection du chef";
            if (data.image) document.getElementById('truck-banner').style.backgroundImage = `url(${data.image})`;
            
            isTruckOpen = data.isOpen;
            const badge = document.getElementById('store-badge');
            badge.innerText = isTruckOpen ? "OUVERT" : "FERM√â";
            badge.style.background = isTruckOpen ? "#4CAF50" : "#FF3B30";

            if (data.specialities) {
                document.getElementById('truck-tags').innerHTML = data.specialities.map(s => 
                    `<span class="tag">${s}</span>`
                ).join('');
            }
        }
    });

    const qMenu = query(collection(db, "menu"), where("truckId", "==", truckId));
    onSnapshot(qMenu, (snap) => {
        products = [];
        snap.forEach(docSnap => {
            const p = docSnap.data();
            products.push({
                id: docSnap.id,
                name: p.name || p.nom,
                price: parseFloat(p.price || p.prix || 0),
                ...p
            });
        });
        renderMenu();
    });

    function renderMenu() {
        const container = document.getElementById('menu-container');
        const nav = document.getElementById('cat-nav');
        
        if (products.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>Menu bient√¥t disponible...</div>";
            return;
        }

        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        nav.innerHTML = categories.map((cat, i) => `
            <a href="#cat-${i}" class="nav-item ${i===0?'active':''}" onclick="setActive(this)">${cat}</a>
        `).join('');

        container.innerHTML = "";
        categories.forEach((cat, i) => {
            let html = `<div id="cat-${i}" class="category-title">${cat}</div>`;
            
            products.filter(p => p.category === cat).forEach(prod => {
                const cartItem = cart.find(item => item.id === prod.id);
                const qty = cartItem ? cartItem.quantity : 0;
                const available = isTruckOpen && prod.stock !== false;
                
                html += `
                    <div class="product-card" style="${!available ? 'opacity: 0.6;' : ''}">
                        <img src="${prod.image || 'https://via.placeholder.com/80'}" class="product-img">
                        <div class="product-info">
                            <div class="product-name">${prod.name}</div>
                            <div class="product-desc">${prod.desc || ''}</div>
                            <div class="product-price">${prod.price.toFixed(2)} ‚Ç¨</div>
                            ${prod.stock === false ? '<div style="color:#FF3B30; font-size:10px; font-weight:bold; margin-top:5px;">√âPUIS√â</div>' : ''}
                        </div>
                        <div class="action-area">
                            ${available ? (
                                qty > 0 ? 
                                `<div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', -1)">‚àí</button>
                                    <div class="qty-display">${qty}</div>
                                    <button class="qty-btn" onclick="updateCart('${prod.id}', 1)">+</button>
                                </div>` :
                                `<div class="add-btn" onclick="updateCart('${prod.id}', 1)">+</div>`
                            ) : ''}
                        </div>
                    </div>`;
            });
            container.innerHTML += html;
        });
        updateCartDisplay();
    }

    window.updateCart = (productId, change) => {
        const prod = products.find(p => p.id === productId);
        if (!isTruckOpen) return alert("‚ö†Ô∏è Ce Food Truck est ferm√©");
        
        const idx = cart.findIndex(item => item.id === productId);
        
        if (cart.length > 0 && cart[0].truckId !== truckId) {
            if (confirm("Votre panier contient des produits d'un autre truck. Le vider ?")) {
                cart = [];
            } else return;
        }

        if (idx >= 0) {
            cart[idx].quantity += change;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
        } else if (change > 0) {
            cart.push({ id: prod.id, name: prod.name, price: prod.price, truckId: truckId, quantity: 1 });
        }

        localStorage.setItem('ff_cart', JSON.stringify(cart));
        renderMenu();
    };

    function updateCartDisplay() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalVal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const bar = document.getElementById('cartBar');
        
        if (totalItems > 0) {
            bar.style.display = 'flex';
            document.getElementById('cartCount').innerText = totalItems;
            document.getElementById('cartTotal').innerText = totalVal.toFixed(2).replace('.', ',') + " ‚Ç¨";
        } else {
            bar.style.display = 'none';
        }
    }

    window.setActive = (el) => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    updateCartDisplay();
</script>

</body>
</html>
