<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - France Food Trucks</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #FF3B30; --bg: #f8f8f8; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; background-color: var(--bg); color: #333; 
            display: flex; justify-content: center; min-height: 100vh;
        }

        .main-wrapper { 
            width: 100%; max-width: 700px; min-height: 100vh; 
            background: var(--bg); position: relative; display: flex; flex-direction: column; 
            border-left: 1px solid #eee; border-right: 1px solid #eee; 
        }

        .header { text-align: center; padding: 15px 0; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 2000; }
        .app-name { font-size: 22px; font-weight: 900; font-style: italic; }
        .app-name span { color: var(--primary); }

        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; max-width: 700px; height: 80px; 
            background: white; border-top: 1px solid #eee; display: flex; 
            justify-content: space-around; align-items: center; z-index: 9999 !important; 
        }

        .top-controls { padding: 15px; background: white; border-bottom: 1px solid #eee; z-index: 1500; position: relative; }
        
        .search-container { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 15px; border: 1px solid #eee; background: #f1f1f1; font-size: 14px; outline: none; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        .filters-row { display: flex; gap: 10px; margin-bottom: 10px; position: relative; }
        .filter-section { flex: 1; }
        
        .filter-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 10px; cursor: pointer; font-weight: 800; font-size: 11px; 
            color: #555; background: #f9f9f9; border: 1px solid #eee; border-radius: 12px;
        }

        .filter-content { 
            display: none; flex-wrap: wrap; gap: 6px; padding: 15px; 
            position: absolute; top: 110%; left: 0; right: 0; 
            background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 3000; border: 1px solid #eee; max-height: 400px; overflow-y: auto;
        }
        
        .filter-content.open { display: flex; }
        .group-title { width: 100%; font-size: 10px; color: #999; font-weight: 900; margin: 10px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 3px; text-transform: uppercase; }
        .arrow { transition: 0.3s; font-size: 8px; color: #bbb; }
        .open-section .arrow { transform: rotate(180deg); }

        .pref-chip { 
            padding: 7px 12px; border-radius: 10px; border: 1px solid #eee; 
            background: #f9f9f9; font-size: 11px; font-weight: bold; cursor: pointer; white-space: nowrap;
        }
        .pref-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .distance-row { display: flex; align-items: center; gap: 15px; padding: 10px 5px; }
        .slider { flex: 1; -webkit-appearance: none; height: 4px; background: #ddd; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #map { width: 100%; height: 130px; border-radius: 20px; transition: 0.4s; z-index: 1; border: 1px solid #eee; }
        .map-wrapper { padding: 10px 15px; background: white; position: relative; z-index: 100; }
        .btn-locate { position: absolute; bottom: 25px; right: 25px; z-index: 1000; background: white; border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; }

        .main-content { padding: 15px; padding-bottom: 100px; flex: 1; }
        .section-title { font-weight: 900; font-size: 11px; color: #bbb; text-transform: uppercase; margin-bottom: 15px; }
        
        .truck-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #eee; position: relative; cursor: pointer; transition: 0.2s; }
        .truck-card.offline { opacity: 0.6; filter: grayscale(1); }
        .offline-tag { font-size: 9px; background: #333; color: white; padding: 3px 8px; border-radius: 6px; font-weight: 900; position: absolute; top: 12px; right: 50px; }

        .truck-img { width: 65px; height: 65px; border-radius: 14px; margin-right: 15px; object-fit: cover; background: #eee; }
        .truck-info { flex: 1; }
        .truck-name { font-weight: 900; font-size: 17px; margin-bottom: 3px; }
        .truck-tags { font-size: 11px; color: #888; line-height: 1.4; }
        
        .fav-btn { font-size: 24px; color: #eee; cursor: pointer; padding: 5px; }
        .fav-btn.active { color: var(--primary); }

        .nav-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: #f8f8f8; color: #ccc; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="app-name">F<span>F</span>oodTrucks</div>
    </div>

    <div class="top-controls">
        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Chercher un food truck...">
        </div>

        <div class="filters-row">
            <div class="filter-section" id="sec-cuisine">
                <div class="filter-header" onclick="toggleFilter('cuisine-content', 'sec-cuisine')">
                    <span>ğŸŒ CUISINES</span>
                    <span class="arrow">â–¼</span>
                </div>
                <div id="cuisine-content" class="filter-content">
                    <div class="group-title">BEST-SELLERS</div>
                    <div class="pref-chip" data-pref="ğŸ” Burgers">ğŸ” Burgers</div>
                    <div class="pref-chip" data-pref="ğŸ¥© Smash">ğŸ¥© Smash Burgers</div>
                    <div class="pref-chip" data-pref="ğŸ• Pizzas">ğŸ• Pizzas</div>
                    <div class="pref-chip" data-pref="ğŸŸ Snacking">ğŸŸ Snacking</div>
                    
                    <div class="group-title">ğŸ‡«ğŸ‡· FRANCE & EUROPE</div>
                    <div class="pref-chip" data-pref="ğŸ¥¨ Terroir">ğŸ‡«ğŸ‡· Terroir (Aligot/Truffade)</div>
                    <div class="pref-chip" data-pref="ğŸ¥ CrÃªpes">ğŸ¥ CrÃªpes & Galettes</div>
                    <div class="pref-chip" data-pref="ğŸ Italie">ğŸ‡®ğŸ‡¹ Italie (PÃ¢tes/Risotto)</div>
                    <div class="pref-chip" data-pref="ğŸ‡ªğŸ‡¸ Espagne">ğŸ‡ªğŸ‡¸ Espagne (Paella/Tapas)</div>
                    <div class="pref-chip" data-pref="ğŸ‡µğŸ‡¹ Portugal">ğŸ‡µğŸ‡¹ Portugal (Poulet braisÃ©)</div>
                    <div class="pref-chip" data-pref="ğŸŸ UK">ğŸ‡¬ğŸ‡§ Fish & Chips</div>

                    <div class="group-title">ğŸŒ AFRIQUE</div>
                    <div class="pref-chip" data-pref="ğŸ‡¸ğŸ‡³ SÃ©nÃ©gal">ğŸ‡¸ğŸ‡³ SÃ©nÃ©gal (Yassa/MafÃ©)</div>
                    <div class="pref-chip" data-pref="ğŸ‡¨ğŸ‡® CÃ´te dâ€™Ivoire">ğŸ‡¨ğŸ‡® CÃ´te dâ€™Ivoire (Garba/Alloco)</div>
                    <div class="pref-chip" data-pref="ğŸ‡¨ğŸ‡² Cameroun">ğŸ‡¨ğŸ‡² Cameroun (NdolÃ©)</div>
                    <div class="pref-chip" data-pref="ğŸ‡²ğŸ‡¦ Maghreb">ğŸ‡²ğŸ‡¦ Maghreb (Couscous/Tajine)</div>

                    <div class="group-title">ğŸï¸ ANTILLES & OCÃ‰AN INDIEN</div>
                    <div class="pref-chip" data-pref="ğŸ‡¬ğŸ‡µ Antilles">ğŸ‡¬ğŸ‡µ Antilles (Bokit/Accras)</div>
                    <div class="pref-chip" data-pref="ğŸ‡·ğŸ‡ª RÃ©union">ğŸ‡·ğŸ‡ª RÃ©union (Rougail Saucisse)</div>
                    <div class="pref-chip" data-pref="ğŸ‡­ğŸ‡¹ HaÃ¯ti">ğŸ‡­ğŸ‡¹ HaÃ¯ti (Griot)</div>

                    <div class="group-title">ğŸŒ® AMÃ‰RIQUES</div>
                    <div class="pref-chip" data-pref="ğŸ‡²ğŸ‡½ Mexique">ğŸ‡²ğŸ‡½ Mexique (Tacos/Burritos)</div>
                    <div class="pref-chip" data-pref="ğŸ‡¨ğŸ‡¦ Canada">ğŸ‡¨ğŸ‡¦ Canada (Poutine)</div>
                    <div class="pref-chip" data-pref="ğŸ‡ºğŸ‡¸ USA">ğŸ‡ºğŸ‡¸ USA Style</div>
                    <div class="pref-chip" data-pref="ğŸ‡§ğŸ‡· BrÃ©sil">ğŸ‡§ğŸ‡· BrÃ©sil & Latino</div>

                    <div class="group-title">ğŸ¥¢ ASIE & ORIENT</div>
                    <div class="pref-chip" data-pref="ğŸ¥¢ Vietnam">ğŸ¥¢ Vietnam (Banh Mi/Pho)</div>
                    <div class="pref-chip" data-pref="ğŸœ ThaÃ¯lande">ğŸœ ThaÃ¯ (Pad ThaÃ¯)</div>
                    <div class="pref-chip" data-pref="ğŸ± Japon">ğŸ± Japon (Ramen/Sushi)</div>
                    <div class="pref-chip" data-pref="ğŸ› Inde">ğŸ› Inde (Curry/Naan)</div>
                    <div class="pref-chip" data-pref="ğŸ¥™ Liban">ğŸ¥™ Liban (MezzÃ©s/Falafel)</div>
                </div>
            </div>

            <div class="filter-section" id="sec-regime">
                <div class="filter-header" onclick="toggleFilter('regime-content', 'sec-regime')">
                    <span>ğŸŒ¿ RÃ‰GIMES</span>
                    <span class="arrow">â–¼</span>
                </div>
                <div id="regime-content" class="filter-content">
                    <div class="group-title">RÃ‰GIMES</div>
                    <div class="pref-chip" data-pref="ğŸ¥— Veggie">ğŸ¥— VÃ©gÃ©tarien</div>
                    <div class="pref-chip" data-pref="ğŸŒ¿ Vegan">ğŸŒ¿ Vegan</div>
                    <div class="pref-chip" data-pref="ğŸ¥© Halal">ğŸ¥© Halal</div>
                    <div class="pref-chip" data-pref="ğŸ• Casher">ğŸ• Casher</div>
                    <div class="pref-chip" data-pref="ğŸŒ¾ Sans Gluten">ğŸŒ¾ Sans Gluten</div>
                    
                    <div class="group-title">QUALITÃ‰</div>
                    <div class="pref-chip" data-pref="ğŸ  Maison">ğŸ  Fait Maison</div>
                    <div class="pref-chip" data-pref="ğŸ“ Local">ğŸ“ Local / Bio</div>
                    <div class="pref-chip" data-pref="ğŸŒ¶ï¸ Ã‰picÃ©">ğŸŒ¶ï¸ Ã‰picÃ©</div>
                </div>
            </div>
        </div>

        <div class="distance-row">
            <span style="font-weight: 900; font-size: 13px; min-width: 65px;">ğŸ“ <span id="dist-val">10</span>km</span>
            <input type="range" min="1" max="100" value="10" class="slider" id="distRange">
        </div>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
        <button class="btn-locate" id="btn-locate">ğŸ¯</button>
    </div>

    <div class="main-content">
        <div class="section-title" id="list-title">Ã€ proximitÃ©</div>
        <div id="trucks-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn" id="nav-fav">â¤ï¸</div>
        <div class="nav-btn active" id="nav-home">ğŸ“</div>
        <div class="nav-btn" id="nav-cart">ğŸ›’</div>
        <div class="nav-btn" id="nav-profile">ğŸ‘¤</div>
    </nav>
</div>

<script type="module">
    import { auth, db } from './firebase-config.js';
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const map = L.map('map', { zoomControl: false }).setView([46.2276, 2.2137], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png').addTo(map);

    let allTrucks = [];
    let favorites = JSON.parse(localStorage.getItem('ff_favs')) || [];
    let activePrefs = [];
    let userMarker;

    const activeFlame = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/426/426833.png', 
        iconSize: [30, 30], iconAnchor: [15, 30]
    });

    window.toggleFilter = (contentId, sectionId) => {
        const content = document.getElementById(contentId);
        const section = document.getElementById(sectionId);
        const alreadyOpen = content.classList.contains('open');
        
        document.querySelectorAll('.filter-content').forEach(c => c.classList.remove('open'));
        document.querySelectorAll('.filter-section').forEach(s => s.classList.remove('open-section'));

        if (!alreadyOpen) {
            content.classList.add('open');
            section.classList.add('open-section');
        }
    };

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-section')) {
            document.querySelectorAll('.filter-content').forEach(c => c.classList.remove('open'));
            document.querySelectorAll('.filter-section').forEach(s => s.classList.remove('open-section'));
        }
    });

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    window.getUserLocation = () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            map.setView([lat, lng], 13);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, fillColor: "#007AFF", color: "white", weight: 3, fillOpacity: 1 }).addTo(map);
            renderTrucks();
        });
    };

    function renderTrucks() {
        const container = document.getElementById('trucks-list');
        const maxDist = parseInt(document.getElementById('distRange').value);
        const search = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = "";
        
        map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarker) map.removeLayer(l); });

        const trucks = [...allTrucks].sort((a,b) => b.isOpen - a.isOpen);
        let count = 0;

        trucks.forEach(t => {
            const isFav = favorites.includes(t.id);
            const truckTags = [...(t.specialities || []), t.category || ""];
            const matchesPrefs = activePrefs.length === 0 || activePrefs.every(p => truckTags.includes(p));
            const matchesSearch = t.truckName.toLowerCase().includes(search);
            
            let dist = userMarker ? getDistance(userMarker.getLatLng().lat, userMarker.getLatLng().lng, t.latitude, t.longitude) : 0;
            const isInRange = !userMarker || dist <= maxDist;

            if (isInRange && matchesPrefs && matchesSearch) {
                count++;
                L.marker([t.latitude, t.longitude], {icon: activeFlame}).addTo(map);
                const card = document.createElement('div');
                card.className = `truck-card ${t.isOpen ? '' : 'offline'}`;
                card.innerHTML = `
                    <img src="${t.image || 'https://via.placeholder.com/65'}" class="truck-img">
                    <div class="truck-info">
                        <div class="truck-name">${t.truckName}</div>
                        <div class="truck-tags">â— ${t.isOpen ? 'En service' : 'FermÃ©'} ${userMarker ? ' â€¢ ' + dist.toFixed(1) + 'km' : ''}<br>${truckTags.filter(x=>x).join(' â€¢ ')}</div>
                    </div>`;
                container.appendChild(card);
            }
        });
    }

    document.querySelectorAll('.pref-chip').forEach(chip => {
        chip.onclick = function() {
            this.classList.toggle('active');
            const p = this.getAttribute('data-pref');
            activePrefs = activePrefs.includes(p) ? activePrefs.filter(x => x !== p) : [...activePrefs, p];
            renderTrucks();
        };
    });

    onSnapshot(collection(db, "trucks"), (snap) => {
        allTrucks = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderTrucks();
    });
    window.getUserLocation();
</script>
</body>
</html>
