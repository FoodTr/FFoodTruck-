<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - France Food Trucks</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #FF3B30; --bg: #f8f8f8; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            background-color: var(--bg); 
            color: #333; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }

        .main-wrapper { 
            width: 100%; 
            max-width: 700px; 
            min-height: 100vh; 
            background: var(--bg); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #eee; 
            border-right: 1px solid #eee; 
        }

        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            max-width: 700px; 
            height: 80px; 
            background: white; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 9999 !important; 
        }

        .header { text-align: center; padding: 15px 0; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 2000; }
        .app-name { font-size: 22px; font-weight: 900; font-style: italic; }
        .app-name span { color: var(--primary); }

        .top-controls { padding: 15px; background: white; border-bottom: 1px solid #eee; z-index: 1500; }
        
        .search-container { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 15px; border: 1px solid #eee; background: #f1f1f1; font-size: 14px; outline: none; box-sizing: border-box; transition: 0.3s; }
        .search-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(255,59,48,0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px; }

        .distance-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .slider { flex: 1; -webkit-appearance: none; height: 4px; background: #ddd; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- NOUVELLES CAT√âGORIES --- */
        .pref-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .pref-nav::-webkit-scrollbar { display: none; }
        .pref-chip { flex: 0 0 auto; padding: 8px 15px; border-radius: 20px; border: 1px solid #eee; background: #f9f9f9; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .pref-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .map-wrapper { padding: 10px 15px; background: white; position: relative; z-index: 100; }
        #map { width: 100%; height: 130px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; cursor: pointer; }
        #map.expanded { height: 380px; }
        .btn-locate { position: absolute; bottom: 25px; right: 25px; z-index: 1000; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; }

        .main-content { padding: 15px; padding-bottom: 100px; flex: 1; }
        .section-title { font-weight: 900; font-size: 13px; color: #999; text-transform: uppercase; margin-bottom: 15px; }
        
        .truck-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s; position: relative; overflow: hidden; cursor: pointer; }
        .truck-card.offline { opacity: 0.7; filter: grayscale(1); }
        .offline-tag { font-size: 9px; background: #333; color: white; padding: 3px 8px; border-radius: 6px; font-weight: 900; position: absolute; top: 12px; right: 45px; }

        .truck-img { width: 60px; height: 60px; border-radius: 14px; margin-right: 12px; object-fit: cover; background: #eee; }
        .truck-info { flex: 1; }
        .truck-name { font-weight: 900; font-size: 16px; margin-bottom: 2px; }
        .truck-tags { font-size: 11px; color: #888; line-height: 1.4; }
        
        .fav-btn { font-size: 24px; color: #ddd; cursor: pointer; transition: 0.2s; padding: 5px; z-index: 5; }
        .fav-btn.active { color: var(--primary); }

        .nav-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: #f8f8f8; color: #ccc; transition: 0.3s; pointer-events: auto !important; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }

        .gray-icon { filter: grayscale(1); opacity: 0.6; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="app-name">F<span>F</span>oodTrucks</div>
    </div>

    <div class="top-controls">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Chercher un Food Truck...">
        </div>

        <div class="distance-row">
            <span style="font-weight: 900; font-size: 14px; min-width: 65px;">üìç <span id="dist-val">10</span>km</span>
            <input type="range" min="1" max="100" value="10" class="slider" id="distRange">
        </div>
        
        <div class="pref-nav" id="prefNav">
            <div class="pref-chip" data-pref="üçî Burgers">üçî Burgers</div>
            <div class="pref-chip" data-pref="ü•© Smash">ü•© Smash</div>
            <div class="pref-chip" data-pref="üçï Pizzas">üçï Pizzas</div>
            <div class="pref-chip" data-pref="üåÆ Tacos">üåÆ Tacos</div>
            <div class="pref-chip" data-pref="üåØ Burritos">üåØ Burritos</div>
            <div class="pref-chip" data-pref="üç± Sushis">üç± Sushis</div>
            <div class="pref-chip" data-pref="üçú Wok">üçú Wok</div>
            <div class="pref-chip" data-pref="ü•ñ Banh Mi">ü•ñ Banh Mi</div>
            <div class="pref-chip" data-pref="ü•ó Healthy">ü•ó Healthy</div>
            <div class="pref-chip" data-pref="ü•û Cr√™pes">ü•û Cr√™pes</div>
            <div class="pref-chip" data-pref="ü•® Terroir">ü•® Terroir</div>
            <div class="pref-chip" data-pref="üåø Vegan">üåø Vegan</div>
            <div class="pref-chip" data-pref="ü•© Halal">ü•© Halal</div>
        </div>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
        <button class="btn-locate" id="btn-locate">üéØ</button>
    </div>

    <div class="main-content">
        <div class="section-title" id="list-title">Autour de vous</div>
        <div id="trucks-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn" id="nav-fav">‚ù§Ô∏è</div>
        <div class="nav-btn active" id="nav-home">üìç</div>
        <div class="nav-btn" id="nav-cart">üõí</div>
        <div class="nav-btn" id="nav-profile">üë§</div>
    </nav>
</div>

<script type="module">
    import { auth, db } from './firebase-config.js';
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const map = L.map('map', { zoomControl: false, minZoom: 2 }).setView([46.2276, 2.2137], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png').addTo(map);

    let allTrucks = [];
    let favorites = JSON.parse(localStorage.getItem('ff_favs')) || [];
    let activePrefs = [];
    let showOnlyFavs = false;
    let userMarker;

    const activeFlame = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/426/426833.png', 
        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
    });
    const offlineFlame = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/426/426833.png', 
        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30], className: 'gray-icon'
    });

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    window.getUserLocation = () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            map.setView([lat, lng], 13);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, fillColor: "#007AFF", color: "white", weight: 2, fillOpacity: 1 }).addTo(map);
            renderTrucks();
        });
    };

    window.expandMap = () => {
        const m = document.getElementById('map');
        if (!m.classList.contains('expanded')) {
            m.classList.add('expanded');
            setTimeout(() => map.invalidateSize(), 400);
        }
    };

    window.toggleFav = (id, event) => {
        event.stopPropagation();
        if (favorites.includes(id)) favorites = favorites.filter(fid => fid !== id);
        else favorites.push(id);
        localStorage.setItem('ff_favs', JSON.stringify(favorites));
        renderTrucks();
    };

    function renderTrucks() {
        const container = document.getElementById('trucks-list');
        const maxDist = parseInt(document.getElementById('distRange').value);
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = "";
        
        map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarker) map.removeLayer(l); });

        const sortedTrucks = [...allTrucks].sort((a, b) => (b.isOpen === a.isOpen) ? 0 : b.isOpen ? 1 : -1);
        let count = 0;

        sortedTrucks.forEach(truck => {
            if (!truck.latitude || !truck.longitude) return;

            const isFav = favorites.includes(truck.id);
            // Recherche intelligente dans category OU specialities
            const matchesPrefs = activePrefs.length === 0 || activePrefs.some(p => 
                (truck.category && truck.category.includes(p)) || 
                (truck.specialities && truck.specialities.includes(p))
            );
            const matchesFavFilter = !showOnlyFavs || isFav;
            const matchesSearch = truck.truckName.toLowerCase().includes(searchQuery);
            
            let distance = null;
            let isInRange = true;
            if (userMarker) {
                distance = getDistance(userMarker.getLatLng().lat, userMarker.getLatLng().lng, truck.latitude, truck.longitude);
                if (distance > maxDist) isInRange = false;
            }

            if (isInRange && matchesPrefs && matchesFavFilter && matchesSearch) {
                count++;
                L.marker([truck.latitude, truck.longitude], {icon: truck.isOpen ? activeFlame : offlineFlame}).addTo(map)
                 .bindPopup(`<b>${truck.truckName}</b>`);

                const card = document.createElement('div');
                card.className = `truck-card ${truck.isOpen ? '' : 'offline'}`;
                
                card.onclick = () => {
                    if (truck.isOpen) window.location.href = `menu.html?id=${truck.id}`;
                    else alert('Hors service pour le moment.');
                };

                card.innerHTML = `
                    ${!truck.isOpen ? '<div class="offline-tag">HORS SERVICE</div>' : ''}
                    <img src="${truck.image || 'https://via.placeholder.com/60'}" class="truck-img">
                    <div class="truck-info">
                        <div class="truck-name">${truck.truckName}</div>
                        <div class="truck-tags">
                            <span style="color: ${truck.isOpen ? '#4CAF50' : '#888'}; font-weight:bold;">‚óè ${truck.isOpen ? 'En service' : 'Ferm√©'}</span> 
                            ${distance ? `‚Ä¢ ${distance.toFixed(1)} km` : ''}<br>
                            ${truck.category || 'Street Food'}
                        </div>
                    </div>
                    <div class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${truck.id}', event)">‚ù§</div>
                `;
                container.appendChild(card);
            }
        });

        if(count === 0) {
            container.innerHTML = `<div style="text-align:center; color:#999; margin-top:30px; font-size:14px;">Aucun r√©sultat trouv√©... üöõ</div>`;
        }
    }

    document.getElementById('map').onclick = window.expandMap;
    document.getElementById('btn-locate').onclick = window.getUserLocation;
    document.getElementById('distRange').oninput = function() {
        document.getElementById('dist-val').innerText = this.value;
        renderTrucks();
    };
    document.getElementById('searchInput').oninput = renderTrucks;

    document.getElementById('nav-fav').onclick = () => {
        showOnlyFavs = true;
        document.getElementById('nav-fav').classList.add('active');
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('list-title').innerText = "Mes Favoris ‚ù§Ô∏è";
        renderTrucks();
    };

    document.getElementById('nav-home').onclick = () => {
        showOnlyFavs = false;
        document.getElementById('nav-fav').classList.remove('active');
        document.getElementById('nav-home').classList.add('active');
        document.getElementById('list-title').innerText = "Autour de vous";
        renderTrucks();
    };

    document.getElementById('nav-profile').onclick = () => {
        if (auth.currentUser) window.location.href = 'profil.html';
        else window.location.href = 'connexion.html';
    };

    document.getElementById('nav-cart').onclick = () => window.location.href = 'panier.html';

    document.querySelectorAll('.pref-chip').forEach(chip => {
        chip.onclick = function() {
            this.classList.toggle('active');
            const p = this.getAttribute('data-pref');
            if (activePrefs.includes(p)) activePrefs = activePrefs.filter(item => item !== p);
            else activePrefs.push(p);
            renderTrucks();
        };
    });

    function init() {
        window.getUserLocation();
        onSnapshot(collection(db, "trucks"), (snap) => {
            allTrucks = [];
            snap.forEach(doc => allTrucks.push({id: doc.id, ...doc.data()}));
            renderTrucks();
        });
    }

    init();
</script>
</body>
</html>
