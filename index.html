<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - France Food Trucks</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

 <link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/client.css">


</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="app-name">F<span>F</span>oodTrucks</div>
    </div>

    <div class="top-controls">
        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Chercher un Food Truck...">
        </div>

        <div class="distance-row">
            <span style="font-weight: 900; font-size: 14px; min-width: 65px;">ğŸ“ <span id="dist-val">10</span>km</span>
            <input type="range" min="1" max="100" value="10" class="slider" id="distRange">
        </div>
        <div class="pref-nav">
            <div class="pref-chip" data-pref="ğŸ” Burger">ğŸ” Burger</div>
            <div class="pref-chip" data-pref="ğŸ• Pizza">ğŸ• Pizza</div>
            <div class="pref-chip" data-pref="ğŸŒ¿ Veggie">ğŸŒ¿ Veggie</div>
            <div class="pref-chip" data-pref="ğŸ¥© Halal">ğŸ¥© Halal</div>
            <div class="pref-chip" data-pref="ğŸŒ® Tacos">ğŸŒ® Tacos</div>
        </div>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
        <button class="btn-locate" id="btn-locate">ğŸ¯</button>
    </div>

    <div class="main-content">
        <div class="section-title" id="list-title">Autour de vous</div>
        <div id="trucks-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn" id="nav-fav">â¤ï¸</div>
        <div class="nav-btn active" id="nav-home">ğŸ“</div>
        <div class="nav-btn" id="nav-cart">ğŸ›’</div>
        <div class="nav-btn" id="nav-profile">ğŸ‘¤</div>
    </nav>
</div>

<script type="module">
    import { auth, db } from './firebase-config.js';
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const map = L.map('map', { zoomControl: false, minZoom: 2 }).setView([46.2276, 2.2137], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png').addTo(map);

    let allTrucks = [];
    let favorites = JSON.parse(localStorage.getItem('ff_favs')) || [];
    let activePrefs = [];
    let showOnlyFavs = false;
    let userMarker;

    const activeFlame = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/426/426833.png', 
        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
    });
    const offlineFlame = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/426/426833.png', 
        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30], className: 'gray-icon'
    });

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    window.getUserLocation = () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            map.setView([lat, lng], 13);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, fillColor: "#007AFF", color: "white", weight: 2, fillOpacity: 1 }).addTo(map);
            renderTrucks();
        });
    };

    window.expandMap = () => {
        const m = document.getElementById('map');
        if (!m.classList.contains('expanded')) {
            m.classList.add('expanded');
            setTimeout(() => map.invalidateSize(), 400);
        }
    };

    window.toggleFav = (id, event) => {
        event.stopPropagation();
        if (favorites.includes(id)) favorites = favorites.filter(fid => fid !== id);
        else favorites.push(id);
        localStorage.setItem('ff_favs', JSON.stringify(favorites));
        renderTrucks();
    };

    function renderTrucks() {
        const container = document.getElementById('trucks-list');
        const maxDist = parseInt(document.getElementById('distRange').value);
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = "";
        
        map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarker) map.removeLayer(l); });

        const sortedTrucks = [...allTrucks].sort((a, b) => (b.isOpen === a.isOpen) ? 0 : b.isOpen ? 1 : -1);
        let count = 0;

        sortedTrucks.forEach(truck => {
            if (!truck.latitude || !truck.longitude) return;

            const isFav = favorites.includes(truck.id);
            const matchesPrefs = activePrefs.length === 0 || activePrefs.some(p => truck.specialities?.includes(p));
            const matchesFavFilter = !showOnlyFavs || isFav;
            const matchesSearch = truck.truckName.toLowerCase().includes(searchQuery);
            
            let distance = null;
            let isInRange = true;
            if (userMarker) {
                distance = getDistance(userMarker.getLatLng().lat, userMarker.getLatLng().lng, truck.latitude, truck.longitude);
                if (distance > maxDist) isInRange = false;
            }

            if (isInRange && matchesPrefs && matchesFavFilter && matchesSearch) {
                count++;
                L.marker([truck.latitude, truck.longitude], {icon: truck.isOpen ? activeFlame : offlineFlame}).addTo(map)
                 .bindPopup(`<b>${truck.truckName}</b>`);

                const card = document.createElement('div');
                card.className = `truck-card ${truck.isOpen ? '' : 'offline'}`;
                
                card.onclick = () => {
                    if (truck.isOpen) window.location.href = `menu.html?id=${truck.id}`;
                    else alert('Hors service pour le moment.');
                };

                card.innerHTML = `
                    ${!truck.isOpen ? '<div class="offline-tag">HORS SERVICE</div>' : ''}
                    <img src="${truck.image || 'https://via.placeholder.com/60'}" class="truck-img">
                    <div class="truck-info">
                        <div class="truck-name">${truck.truckName}</div>
                        <div class="truck-tags">
                            <span style="color: ${truck.isOpen ? '#4CAF50' : '#888'};">â— ${truck.isOpen ? 'En service' : 'FermÃ©'}</span> 
                            ${distance ? `â€¢ ${distance.toFixed(1)} km` : ''}<br>
                            ${truck.specialities ? truck.specialities.join(' â€¢ ') : 'Street Food'}
                        </div>
                    </div>
                    <div class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${truck.id}', event)">â¤</div>
                `;
                container.appendChild(card);
            }
        });

        if(count === 0) {
            container.innerHTML = `<div style="text-align:center; color:#999; margin-top:30px; font-size:14px;">Aucun rÃ©sultat... ğŸš›</div>`;
        }
    }

    document.getElementById('map').onclick = window.expandMap;
    document.getElementById('btn-locate').onclick = window.getUserLocation;
    document.getElementById('distRange').oninput = function() {
        document.getElementById('dist-val').innerText = this.value;
        renderTrucks();
    };
    document.getElementById('searchInput').oninput = renderTrucks;

    document.getElementById('nav-fav').onclick = () => {
        showOnlyFavs = true;
        document.getElementById('nav-fav').classList.add('active');
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('list-title').innerText = "Mes Favoris â¤ï¸";
        renderTrucks();
    };

    document.getElementById('nav-home').onclick = () => {
        showOnlyFavs = false;
        document.getElementById('nav-fav').classList.remove('active');
        document.getElementById('nav-home').classList.add('active');
        document.getElementById('list-title').innerText = "Autour de vous";
        renderTrucks();
    };

    document.getElementById('nav-profile').onclick = () => {
        if (auth.currentUser) window.location.href = 'profil.html';
        else window.location.href = 'connexion.html';
    };

    document.getElementById('nav-cart').onclick = () => window.location.href = 'panier.html';

    document.querySelectorAll('.pref-chip').forEach(chip => {
        chip.onclick = function() {
            this.classList.toggle('active');
            const p = this.getAttribute('data-pref');
            if (activePrefs.includes(p)) activePrefs = activePrefs.filter(item => item !== p);
            else activePrefs.push(p);
            renderTrucks();
        };
    });

    function init() {
        window.getUserLocation();
        onSnapshot(collection(db, "trucks"), (snap) => {
            allTrucks = [];
            snap.forEach(doc => allTrucks.push({id: doc.id, ...doc.data()}));
            renderTrucks();
        });
    }

    init();
</script>
</body>
</html>
