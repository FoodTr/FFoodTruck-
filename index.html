<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - France Food Trucks</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #FF3B30; --bg: #f8f8f8; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; background-color: var(--bg); color: #333; 
            display: flex; justify-content: center; min-height: 100vh;
        }

        .main-wrapper { 
            width: 100%; max-width: 700px; min-height: 100vh; 
            background: var(--bg); position: relative; display: flex; flex-direction: column; 
            border-left: 1px solid #eee; border-right: 1px solid #eee; 
        }

        /* Header */
        .header { text-align: center; padding: 15px 0; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 2000; }
        .app-name { font-size: 22px; font-weight: 900; font-style: italic; }
        .app-name span { color: var(--primary); }

        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; max-width: 700px; height: 80px; 
            background: white; border-top: 1px solid #eee; display: flex; 
            justify-content: space-around; align-items: center; z-index: 9999 !important; 
        }

        /* Controls & Side-by-Side Filters */
        .top-controls { padding: 15px; background: white; border-bottom: 1px solid #eee; z-index: 1500; }
        
        .search-container { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 15px; border: 1px solid #eee; background: #f1f1f1; font-size: 14px; outline: none; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        /* Le container pour mettre c√¥te √† c√¥te */
        .filters-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-section { flex: 1; position: relative; }
        
        .filter-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 10px; cursor: pointer; font-weight: 800; font-size: 11px; 
            color: #555; background: #f9f9f9; border: 1px solid #eee; border-radius: 12px;
        }

        /* Contenu flottant pour ne pas d√©caler toute la page √† l'ouverture */
        .filter-content { 
            display: none; flex-wrap: wrap; gap: 6px; padding: 12px; 
            position: absolute; top: 110%; left: 0; width: 200%; 
            background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 3000; border: 1px solid #eee;
        }
        /* Pour que le 2√®me menu s'aligne √† droite */
        #sec-regime .filter-content { left: auto; right: 0; }
        
        .filter-content.open { display: flex; }
        .arrow { transition: 0.3s; font-size: 8px; color: #bbb; }
        .open-section .arrow { transform: rotate(180deg); }

        .pref-chip { 
            padding: 7px 12px; border-radius: 10px; border: 1px solid #eee; 
            background: #f9f9f9; font-size: 11px; font-weight: bold; cursor: pointer; 
        }
        .pref-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .distance-row { display: flex; align-items: center; gap: 15px; padding: 10px 5px; }
        .slider { flex: 1; -webkit-appearance: none; height: 4px; background: #ddd; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Map & Cards */
        #map { width: 100%; height: 130px; border-radius: 20px; transition: 0.4s; z-index: 1; border: 1px solid #eee; }
        #map.expanded { height: 350px; }
        .map-wrapper { padding: 10px 15px; background: white; position: relative; z-index: 100; }
        .btn-locate { position: absolute; bottom: 25px; right: 25px; z-index: 1000; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; }

        .main-content { padding: 15px; padding-bottom: 100px; flex: 1; }
        .section-title { font-weight: 900; font-size: 11px; color: #bbb; text-transform: uppercase; margin-bottom: 15px; }
        
        .truck-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #eee; position: relative; cursor: pointer; }
        .truck-card.offline { opacity: 0.6; filter: grayscale(1); }
        .offline-tag { font-size: 9px; background: #333; color: white; padding: 3px 8px; border-radius: 6px; font-weight: 900; position: absolute; top: 12px; right: 45px; }

        .truck-img { width: 60px; height: 60px; border-radius: 12px; margin-right: 12px; object-fit: cover; background: #eee; }
        .truck-info { flex: 1; }
        .truck-name { font-weight: 900; font-size: 16px; margin-bottom: 2px; }
        .truck-tags { font-size: 11px; color: #888; line-height: 1.4; }
        
        .fav-btn { font-size: 24px; color: #eee; cursor: pointer; padding: 5px; }
        .fav-btn.active { color: var(--primary); }

        .nav-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: #f8f8f8; color: #ccc; }
        .nav-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="app-name">F<span>F</span>oodTrucks</div>
    </div>

    <div class="top-controls">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Quel food truck aujourd'hui ?">
        </div>

        <div class="filters-row">
            <div class="filter-section" id="sec-cuisine">
                <div class="filter-header" onclick="toggleFilter('cuisine-content', 'sec-cuisine')">
                    <span>üçï CUISINES</span>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="cuisine-content" class="filter-content">
                    <div class="pref-chip" data-pref="üçî Burgers">üçî Burgers</div>
                    <div class="pref-chip" data-pref="ü•© Smash">ü•© Smash</div>
                    <div class="pref-chip" data-pref="üçï Pizzas">üçï Pizzas</div>
                    <div class="pref-chip" data-pref="üåÆ Tacos">üåÆ Tacos</div>
                    <div class="pref-chip" data-pref="ü•ô Kebabs">ü•ô Kebabs</div>
                    <div class="pref-chip" data-pref="üç± Sushis">üç± Sushis</div>
                    <div class="pref-chip" data-pref="ü•û Cr√™pes">ü•û Cr√™pes</div>
                    <div class="pref-chip" data-pref="üç© Desserts">üç© Desserts</div>
                </div>
            </div>

            <div class="filter-section" id="sec-regime">
                <div class="filter-header" onclick="toggleFilter('regime-content', 'sec-regime')">
                    <span>üåø R√âGIMES</span>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="regime-content" class="filter-content">
                    <div class="pref-chip" data-pref="ü•ó Veggie">ü•ó Veggie</div>
                    <div class="pref-chip" data-pref="üåø Vegan">üåø Vegan</div>
                    <div class="pref-chip" data-pref="ü•© Halal">ü•© Halal</div>
                    <div class="pref-chip" data-pref="üïé Casher">üïé Casher</div>
                    <div class="pref-chip" data-pref="üåæ Sans Gluten">üåæ Gluten-Free</div>
                    <div class="pref-chip" data-pref="üè† Maison">üè† Maison</div>
                </div>
            </div>
        </div>

        <div class="distance-row">
            <span style="font-weight: 900; font-size: 13px; min-width: 65px;">üìç <span id="dist-val">10</span>km</span>
            <input type="range" min="1" max="100" value="10" class="slider" id="distRange">
        </div>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
        <button class="btn-locate" id="btn-locate">üéØ</button>
    </div>

    <div class="main-content">
        <div class="section-title" id="list-title">√Ä proximit√©</div>
        <div id="trucks-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn" id="nav-fav">‚ù§Ô∏è</div>
        <div class="nav-btn active" id="nav-home">üìç</div>
        <div class="nav-btn" id="nav-cart">üõí</div>
        <div class="nav-btn" id="nav-profile">üë§</div>
    </nav>
</div>

<script type="module">
    import { auth, db } from './firebase-config.js';
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const map = L.map('map', { zoomControl: false }).setView([46.2276, 2.2137], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png').addTo(map);

    let allTrucks = [];
    let favorites = JSON.parse(localStorage.getItem('ff_favs')) || [];
    let activePrefs = [];
    let userMarker;

    // Toggle Filtres (Ferme l'autre quand on en ouvre un)
    window.toggleFilter = (contentId, sectionId) => {
        const content = document.getElementById(contentId);
        const section = document.getElementById(sectionId);
        const alreadyOpen = content.classList.contains('open');
        
        document.querySelectorAll('.filter-content').forEach(c => c.classList.remove('open'));
        document.querySelectorAll('.filter-section').forEach(s => s.classList.remove('open-section'));

        if (!alreadyOpen) {
            content.classList.add('open');
            section.classList.add('open-section');
        }
    };

    // Fermer les menus si on clique ailleurs
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-section')) {
            document.querySelectorAll('.filter-content').forEach(c => c.classList.remove('open'));
            document.querySelectorAll('.filter-section').forEach(s => s.classList.remove('open-section'));
        }
    });

    // ... Reste de la logique (Distance, Geolocation, Rendu) identique au pr√©c√©dent ...
    // [Logique simplifi√©e pour le rendu]
    function renderTrucks() {
        const container = document.getElementById('trucks-list');
        const maxDist = parseInt(document.getElementById('distRange').value);
        container.innerHTML = "";
        
        allTrucks.forEach(t => {
            const matchesPrefs = activePrefs.length === 0 || activePrefs.every(p => [...(t.specialities||[]), t.category].includes(p));
            if (matchesPrefs) {
                const card = document.createElement('div');
                card.className = `truck-card ${t.isOpen ? '' : 'offline'}`;
                card.innerHTML = `<img src="${t.image||'https://via.placeholder.com/60'}" class="truck-img"><div class="truck-info"><div class="truck-name">${t.truckName}</div><div class="truck-tags">‚óè ${t.isOpen?'Ouvert':'Ferm√©'}</div></div><div class="fav-btn">‚ù§</div>`;
                container.appendChild(card);
            }
        });
    }

    document.querySelectorAll('.pref-chip').forEach(chip => {
        chip.onclick = function() {
            this.classList.toggle('active');
            const p = this.getAttribute('data-pref');
            activePrefs = activePrefs.includes(p) ? activePrefs.filter(x => x !== p) : [...activePrefs, p];
            renderTrucks();
        };
    });

    onSnapshot(collection(db, "trucks"), (snap) => {
        allTrucks = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderTrucks();
    });
</script>
</body>
</html>
