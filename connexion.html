<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FFoodTrucks - Connexion & Inscription</title>

```
<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/client.css">
```

</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <div class="back-btn" id="btn-back">‹</div>
        <div class="app-name">F<span>F</span>oodTrucks</div>
    </div>

<div class="container">
    <div class="tabs">
        <div class="tab active" id="tab-login">Connexion</div>
        <div class="tab" id="tab-signup">Inscription</div>
    </div>

```
<form id="auth-form">
    <div id="signup-fields" style="display: none;">
        <div class="form-row">
            <div class="form-group">
                <label>Nom</label>
                <input type="text" id="lastName" class="form-input" placeholder="Dupont">
            </div>
            <div class="form-group">
                <label>Prénom</label>
                <input type="text" id="firstName" class="form-input" placeholder="Jean">
            </div>
        </div>
        <div class="form-group">
            <label>Téléphone</label>
            <input type="tel" id="phone" class="form-input" placeholder="0600000000">
        </div>
    </div>

    <div class="form-group">
        <label>Adresse Mail</label>
        <input type="email" id="email" class="form-input" placeholder="votre@email.com" required>
    </div>

    <div class="form-group">
        <label>Mot de passe</label>
        <input type="password" id="password" class="form-input" placeholder="••••••••" required>
    </div>

    <button type="submit" class="submit-btn" id="main-btn">Se connecter</button>
    
    <div class="forgot-pass" id="forgot-text">Mot de passe oublié ?</div>
</form>
```

</div>

<div style="text-align: center; padding: 20px; font-size: 13px; margin-top: 30px; color: #666; width: 100%;">
    Vous êtes restaurateur ? <span style="color: #FF3B30; font-weight: bold; cursor: pointer; text-decoration: underline;" id="go-gerant">Accès Gérant</span>
</div>

</div>

<script type="module">
    import { auth, db, ts } from './firebase-config.js';
    import { 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        sendPasswordResetEmail 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let mode = 'login';

    // Navigation
    document.getElementById('btn-back').onclick = () => {
        if (window.history.length > 1) window.history.back();
        else window.location.href = 'index.html';
    };

    document.getElementById('go-gerant').onclick = () => window.location.href = 'gerant_auth.html';

    // Gestion des Onglets
    const switchTab = (type) => {
        mode = type;
        const isSignup = (type === 'signup');
        document.getElementById('tab-signup').classList.toggle('active', isSignup);
        document.getElementById('tab-login').classList.toggle('active', !isSignup);
        document.getElementById('signup-fields').style.display = isSignup ? 'block' : 'none';
        document.getElementById('main-btn').innerText = isSignup ? "Créer mon compte" : "Se connecter";
        document.getElementById('forgot-text').style.display = isSignup ? 'none' : 'block';
    };

    document.getElementById('tab-login').onclick = () => switchTab('login');
    document.getElementById('tab-signup').onclick = () => switchTab('signup');

    // Mot de passe oublié
    document.getElementById('forgot-text').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        if (!email) return alert("⚠️ Veuillez saisir votre email d'abord.");
        
        try {
            await sendPasswordResetEmail(auth, email);
            alert("✅ Lien de réinitialisation envoyé !");
        } catch (e) {
            alert("❌ Erreur : " + e.message);
        }
    };

    // Formulaire
    document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const btn = document.getElementById('main-btn');

        btn.disabled = true;
        btn.innerText = "Chargement...";

        try {
            if (mode === 'login') {
                const userCred = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, "users", userCred.user.uid));
                
                if (userDoc.exists() && userDoc.data().role === 'gerant') {
                    window.location.href = 'gerant_dashboard.html';
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                // Inscription Client
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const phone = document.getElementById('phone').value.trim();

                if (!firstName || !lastName) throw new Error("Nom et prénom obligatoires");

                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                
                await setDoc(doc(db, "users", userCred.user.uid), {
                    uid: userCred.user.uid,
                    firstName,
                    lastName,
                    phone,
                    email,
                    role: "client",
                    createdAt: ts()
                });

                alert("✅ Bienvenue !");
                window.location.href = 'index.html';
            }
        } catch (error) {
            alert("❌ " + error.message);
            btn.disabled = false;
            btn.innerText = mode === 'login' ? "Se connecter" : "Créer mon compte";
        }
    };
</script>

</body>
</html>